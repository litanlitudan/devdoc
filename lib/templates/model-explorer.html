<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Model Explorer - {{filename}}</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Google Sans Text', 'Roboto', Arial, sans-serif;
			background: #1a1a1a;
			color: #e0e0e0;
			overflow: hidden;
		}

		.visualizer-container {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: #1a1a1a;
		}

		model-explorer-visualizer {
			width: 100%;
			height: 100%;
			display: block;
		}

		.loading {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			text-align: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid #404040;
			border-top-color: #667eea;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 16px;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		.error {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: #2d2d2d;
			padding: 24px;
			border-radius: 8px;
			border: 1px solid #f87171;
			max-width: 500px;
		}

		.error-title {
			color: #f87171;
			font-size: 16px;
			font-weight: 500;
			margin-bottom: 12px;
		}

		.error-message {
			color: #9ca3af;
			font-size: 14px;
			line-height: 1.5;
		}
	</style>
</head>
<body>
	<div class="visualizer-container">
		<div class="loading" id="loading">
			<div class="spinner"></div>
			<div>Loading MLIR model...</div>
		</div>
		<div class="error" id="error" style="display: none;">
			<div class="error-title">Error Loading Model</div>
			<div class="error-message" id="error-message"></div>
		</div>
	</div>

	<!-- Load Model Explorer from local files -->
	<script src="/lib/model-explorer/main_browser.js"></script>

	<script id="graph-data" type="application/json">{{graphData}}</script>

	<script>
		// Configure Model Explorer paths to use local files
		if (window.modelExplorer) {
			window.modelExplorer.workerScriptPath = '/lib/model-explorer/worker.js';
			window.modelExplorer.assetFilesBaseUrl = '/lib/model-explorer/static_files';
		}

		// Parse graph data from JSON script tag
		const graphDataElement = document.getElementById('graph-data');
		const graphData = JSON.parse(graphDataElement.textContent);

		async function loadMLIRModel() {
			try {
				// Validate graph data
				if (!graphData) {
					throw new Error('Graph data is null or undefined');
				}

				// Handle both multi-graph format and single graph format
				let graphs;
				if (graphData.graphs && Array.isArray(graphData.graphs)) {
					// Multi-graph format: {graphs: [{id, nodes}, ...]}
					graphs = graphData.graphs;
				} else if (graphData.nodes && Array.isArray(graphData.nodes)) {
					// Single graph format: {id, nodes}
					graphs = [graphData];
				} else {
					throw new Error('Graph data must contain either .graphs array or .nodes array');
				}

				if (graphs.length === 0) {
					throw new Error('No graphs found in MLIR file');
				}

				// Validate each graph has nodes
				for (const graph of graphs) {
					if (!graph.nodes || !Array.isArray(graph.nodes)) {
						throw new Error(`Graph "${graph.id || 'unknown'}" is missing nodes array`);
					}
				}

				// Create and configure the visualizer
				const visualizer = document.createElement('model-explorer-visualizer');

				// Set graph collections with proper structure
				const graphCollections = [{
					label: '{{filename}}',
					graphs: graphs
				}];

				visualizer.graphCollections = graphCollections;

				// Configure default visualization settings
				// Note: Model Explorer persists user's "View on Node/Edge" selections in localStorage.
				// This config ensures the options are available. Users can select their preferences
				// from the UI, and they will be remembered across sessions.
				visualizer.config = {
					// Ensure "View on Node" options are available (not hidden)
					viewOnNodeConfig: {
						hideOpNodeId: false,           // ✓ Show "Op node id" option
						hideOpNodeInputs: false,       // ✓ Show "Op node inputs" option
						hideOpNodeOutputs: false,      // ✓ Show "Op node outputs" option
						hideOpNodeAttributes: false,   // ✓ Keep attributes option available
						hideLayerNodeChildrenCount: false  // ✓ Keep layer children count available
					}
				};

				// Add to DOM
				const container = document.querySelector('.visualizer-container');
				container.appendChild(visualizer);

				// Hide loading after allowing time to render
				setTimeout(() => {
					document.getElementById('loading').style.display = 'none';
				}, 1000);

			} catch (error) {
				console.error('Error loading MLIR model:', error);
				document.getElementById('loading').style.display = 'none';
				const errorDiv = document.getElementById('error');
				errorDiv.style.display = 'block';
				document.getElementById('error-message').textContent = error.message;
			}
		}

		// Wait for Model Explorer custom element to be defined
		if (customElements.get('model-explorer-visualizer')) {
			setTimeout(loadMLIRModel, 100);
		} else {
			customElements.whenDefined('model-explorer-visualizer').then(() => {
				setTimeout(loadMLIRModel, 100);
			});
		}
	</script>
</body>
</html>
